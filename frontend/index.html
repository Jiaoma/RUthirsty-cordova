<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>团队矛盾冲突模拟器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .header .subtitle { font-size: 14px; opacity: 0.9; }
        
        /* 案例选择界面 */
        #caseSelectScreen { padding: 40px; text-align: center; }
        #caseSelectScreen h2 { color: #333; margin-bottom: 10px; }
        #caseSelectScreen p { color: #666; margin-bottom: 30px; }
        .case-list { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .case-card {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 250px;
            max-width: 300px;
            text-align: left;
        }
        .case-card:hover { border-color: #667eea; transform: translateY(-3px); }
        .case-card.selected { border-color: #667eea; background: #e8eaf6; }
        .case-card h3 { color: #667eea; margin-bottom: 10px; font-size: 16px; }
        .case-card .desc { color: #666; font-size: 13px; line-height: 1.5; margin-bottom: 10px; }
        .case-card .meta { color: #999; font-size: 12px; }
        
        /* 角色选择界面 */
        #roleSelectScreen { display: none; padding: 40px; text-align: center; }
        #roleSelectScreen h2 { color: #333; margin-bottom: 20px; }
        #roleSelectScreen p { color: #666; margin-bottom: 30px; }
        .role-list { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .role-card {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 20px 30px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 180px;
        }
        .role-card:hover { border-color: #667eea; transform: translateY(-3px); }
        .role-card.selected { border-color: #667eea; background: #e8eaf6; }
        .role-card h3 { color: #667eea; margin-bottom: 8px; }
        .role-card .role { color: #666; font-size: 14px; margin-bottom: 5px; }
        .role-card .team { color: #999; font-size: 12px; }
        
        /* 游戏界面 */
        #gameScreen { display: none; }
        .game-info { padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .game-info h2 { font-size: 18px; margin-bottom: 10px; }
        .game-info p { color: #666; line-height: 1.6; }
        .player-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .dialogue-area { padding: 30px; min-height: 300px; max-height: 450px; overflow-y: auto; }
        .message { margin-bottom: 15px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message .speaker { font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .message.player .speaker { color: #764ba2; }
        .message .content { background: #f8f9fa; padding: 12px 16px; border-radius: 8px; line-height: 1.6; }
        .message.player .content { background: #e8eaf6; }
        
        .options-area { padding: 25px; background: #f8f9fa; border-top: 1px solid #e9ecef; }
        .options-title { font-weight: bold; margin-bottom: 15px; color: #333; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover { border-color: #667eea; transform: translateY(-2px); }
        .option .label { 
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .option .text { color: #333; font-size: 14px; line-height: 1.5; }
        
        .controls { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e9ecef; }
        .round-info { color: #666; font-size: 14px; }
        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading::after { content: ''; animation: dots 1.5s infinite; }
        @keyframes dots { 0%,20% { content: '.'; } 40% { content: '..'; } 60%,100% { content: '...'; } }
        
        .error { background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 15px; margin: 20px; color: #721c24; }
        .end-box { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin: 20px; }
        .end-box h3 { color: #856404; margin-bottom: 10px; }
        
        @media (max-width: 600px) {
            .options { grid-template-columns: 1fr; }
            .case-list { flex-direction: column; align-items: center; }
            .role-list { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>团队矛盾冲突模拟器</h1>
            <div class="subtitle">通过角色扮演，体验不同的沟通策略</div>
        </div>
        
        <!-- 案例选择 -->
        <div id="caseSelectScreen">
            <h2>选择学习案例</h2>
            <p>点击下方案例卡选择，然后点击"下一步"</p>
            <div class="case-list" id="caseList">
                <div class="loading">加载案例列表...</div>
            </div>
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" id="nextToRoleBtn" onclick="goToRoleSelect()" disabled>下一步：选择角色</button>
            </div>
        </div>
        
        <!-- 角色选择 -->
        <div id="roleSelectScreen">
            <h2 id="selectedCaseTitle">选择你要扮演的角色</h2>
            <p>点击下方角色卡选择，然后点击"开始游戏"</p>
            <div class="role-list" id="roleList"></div>
            <div style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="backToCaseSelect()">上一步</button>
                <button class="btn btn-primary" id="startBtn" onclick="startGame()" disabled>开始游戏</button>
            </div>
        </div>
        
        <!-- 游戏界面 -->
        <div id="gameScreen">
            <div class="game-info">
                <h2 id="caseTitle"></h2>
                <p id="caseBackground"></p>
                <div class="player-badge">你扮演：<span id="playerRole"></span></div>
            </div>
            <div class="dialogue-area" id="dialogueArea">
                <div class="loading">正在加载对话...</div>
            </div>
            <div class="options-area" id="optionsArea" style="display:none;">
                <div class="options-title">请选择你的回复：</div>
                <div class="options" id="options"></div>
            </div>
            <div class="controls">
                <div class="round-info">轮次: <span id="roundInfo">0</span> / <span id="maxRounds">10</span></div>
                <div>
                    <button class="btn btn-secondary" onclick="location.reload()">重新开始</button>
                    <button class="btn btn-primary" id="continueBtn" onclick="getOptions()" style="display:none;">继续游戏</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API = 'http://localhost:5000/api';
        let state = { 
            selectedCase: null, 
            selectedRole: null, 
            caseData: null, 
            round: 0, 
            maxRounds: 10 
        };
        
        // 页面加载时获取案例列表
        async function init() {
            console.log('[INIT] 开始加载');
            try {
                const resp = await fetch(API + '/cases');
                const data = await resp.json();
                console.log('[INIT] 案例列表:', data.success);
                
                if (data.success) {
                    showCaseSelection(data.cases);
                } else {
                    showError('加载案例列表失败: ' + data.error);
                }
            } catch (e) {
                console.error('[INIT] 错误:', e);
                document.querySelector('.container').innerHTML = '<div class="error">加载失败: ' + e.message + '</div>';
            }
        }
        
        function showCaseSelection(cases) {
            console.log('[CASES] 显示案例列表', cases.length);
            const list = document.getElementById('caseList');
            list.innerHTML = '';
            
            cases.forEach((c, i) => {
                const card = document.createElement('div');
                card.className = 'case-card';
                card.innerHTML = '<h3>' + c.title + '</h3>' +
                    '<div class="desc">' + (c.description || '暂无描述') + '</div>' +
                    '<div class="meta">角色数: ' + c.characters_count + '</div>';
                card.onclick = () => selectCase(c, card);
                list.appendChild(card);
            });
        }
        
        function selectCase(caseInfo, card) {
            state.selectedCase = caseInfo;
            document.querySelectorAll('.case-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('nextToRoleBtn').disabled = false;
            console.log('[CASES] 选中案例:', caseInfo.title);
        }
        
        async function goToRoleSelect() {
            if (!state.selectedCase) return;
            console.log('[ROLES] 加载角色列表');
            
            try {
                const resp = await fetch(API + '/select_case', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({case_filename: state.selectedCase.filename})
                });
                const data = await resp.json();
                
                if (data.success) {
                    state.caseData = data.case;
                    state.maxRounds = data.max_rounds;
                    
                    // 切换到角色选择界面
                    document.getElementById('caseSelectScreen').style.display = 'none';
                    document.getElementById('roleSelectScreen').style.display = 'block';
                    document.getElementById('selectedCaseTitle').textContent = 
                        '案例: ' + state.caseData.title + ' - 选择角色';
                    
                    showRoleSelection(data.case.characters);
                } else {
                    showError('加载案例失败: ' + data.error);
                }
            } catch (e) {
                showError('加载失败: ' + e.message);
            }
        }
        
        function showRoleSelection(chars) {
            console.log('[ROLES] 显示角色选择', chars.length);
            const list = document.getElementById('roleList');
            list.innerHTML = '';
            
            chars.forEach((c, i) => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.innerHTML = '<h3>' + c.name + '</h3>' +
                    '<div class="role">' + c.role + '</div>' +
                    '<div class="team">' + c.team + '</div>';
                card.onclick = () => selectRole(c, card);
                list.appendChild(card);
            });
        }
        
        function selectRole(char, card) {
            state.selectedRole = char.name;
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('startBtn').disabled = false;
            console.log('[ROLES] 选中角色:', char.name);
        }
        
        function backToCaseSelect() {
            document.getElementById('roleSelectScreen').style.display = 'none';
            document.getElementById('caseSelectScreen').style.display = 'block';
            state.selectedRole = null;
            document.getElementById('startBtn').disabled = true;
        }
        
        async function startGame() {
            if (!state.selectedRole) return;
            console.log('[START] 开始游戏', state.selectedRole);
            
            try {
                await fetch(API + '/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player_role: state.selectedRole})
                });
            } catch (e) { console.log('[START] 后端调用跳过', e.message); }
            
            document.getElementById('roleSelectScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            document.getElementById('caseTitle').textContent = state.caseData.title;
            document.getElementById('caseBackground').textContent = state.caseData.background;
            document.getElementById('playerRole').textContent = state.selectedRole;
            document.getElementById('maxRounds').textContent = state.maxRounds;
            
            const dialogue = document.getElementById('dialogueArea');
            dialogue.innerHTML = '';
            
            const resp = await fetch(API + '/init');
            const data = await resp.json();
            
            data.initial_dialogue.forEach(msg => {
                const isPlayer = msg.speaker === state.selectedRole;
                dialogue.innerHTML += '<div class="message' + (isPlayer ? ' player' : '') + '">' +
                    '<div class="speaker">' + msg.speaker + '</div>' +
                    '<div class="content">' + msg.content + '</div></div>';
            });
            
            dialogue.scrollTop = dialogue.scrollHeight;
            document.getElementById('continueBtn').style.display = 'inline-block';
            console.log('[START] 游戏开始完成');
        }
        
        async function getOptions() {
            document.getElementById('continueBtn').style.display = 'none';
            document.getElementById('optionsArea').style.display = 'block';
            document.getElementById('options').innerHTML = '<div class="loading">AI正在生成选项...</div>';
            
            try {
                const resp = await fetch(API + '/get_options', { method: 'POST' });
                const data = await resp.json();
                
                if (data.success) {
                    const optDiv = document.getElementById('options');
                    optDiv.innerHTML = '';
                    data.options.forEach(o => {
                        optDiv.innerHTML += '<div class="option" onclick="makeChoice(\'' + o.label + '\', \'' + 
                            o.content.replace(/'/g, "\\'") + '\')">' +
                            '<div class="label">' + o.label + '</div><div class="text">' + o.content + '</div></div>';
                    });
                } else {
                    document.getElementById('options').innerHTML = '<div class="error">获取选项失败: ' + data.error + '</div>';
                }
            } catch (e) {
                document.getElementById('options').innerHTML = '<div class="error">连接失败: ' + e.message + '</div>';
            }
        }
        
        async function makeChoice(label, content) {
            document.getElementById('optionsArea').style.display = 'none';
            
            const dialogue = document.getElementById('dialogueArea');
            dialogue.innerHTML += '<div class="message player"><div class="speaker">' + state.selectedRole + '</div>' +
                '<div class="content">' + content + '</div></div>';
            dialogue.scrollTop = dialogue.scrollHeight;
            
            dialogue.innerHTML += '<div class="loading" id="loading">AI正在思考...</div>';
            dialogue.scrollTop = dialogue.scrollHeight;
            
            try {
                const resp = await fetch(API + '/make_choice', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({choice: content})
                });
                const data = await resp.json();
                
                document.getElementById('loading').remove();
                
                if (data.success) {
                    if (data.npc_responses) {
                        data.npc_responses.forEach(msg => {
                            dialogue.innerHTML += '<div class="message"><div class="speaker">' + msg.speaker + '</div>' +
                                '<div class="content">' + msg.content + '</div></div>';
                        });
                    }
                    
                    state.round = data.current_round;
                    document.getElementById('roundInfo').textContent = state.round;
                    
                    if (data.is_end || state.round >= state.maxRounds) {
                        dialogue.innerHTML += '<div class="end-box"><h3>游戏结束</h3><p>' + 
                            (data.end_summary || '感谢参与！') + '</p></div>';
                    } else {
                        document.getElementById('continueBtn').style.display = 'inline-block';
                    }
                }
                dialogue.scrollTop = dialogue.scrollHeight;
            } catch (e) {
                document.getElementById('loading').innerHTML = '<div class="error">处理失败: ' + e.message + '</div>';
            }
        }
        
        function showError(msg) {
            document.querySelector('.container').innerHTML = '<div class="error">' + msg + '</div>';
        }
        
        window.onload = init;
    </script>
</body>
</html>
